name: Test on Demand

# Manual trigger with customizable inputs
on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to test on'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
      
      tags:
        description: 'Test tags to run'
        required: true
        default: '@regression'
        type: choice
        options:
          - '@smoke'
          - '@regression'
          - all
      
      environment:
        description: 'Test environment'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - staging
          - production
      
      retries:
        description: 'Number of retries for failed tests'
        required: false
        default: '1'
        type: choice
        options:
          - '0'
          - '1'
          - '2'
          - '3'
      
      debug:
        description: 'Enable debug mode (traces on all tests)'
        required: false
        default: false
        type: boolean

# Permissions required for test results publishing
permissions:
  contents: read
  checks: write

env:
  NODE_VERSION: '20'
  TEST_ENVIRONMENT: ${{ inputs.environment }}
  TEST_TRIGGER: 'on_demand'

jobs:
  test:
    name: Run Tests (${{ inputs.browser }} - ${{ inputs.tags }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ðŸ“š Install dependencies
        run: npm ci
      
      - name: ðŸŽ­ Install Playwright browsers
        run: |
          if [ "${{ inputs.browser }}" = "all" ]; then
            npx playwright install --with-deps
          else
            npx playwright install --with-deps ${{ inputs.browser }}
          fi
      
      - name: ðŸ—ï¸ Build application
        run: npm run build
      
      - name: ðŸ“ Create auth directory
        run: mkdir -p .auth
      
      - name: ðŸ”§ Configure test options
        id: config
        run: |
          # Set browser project
          if [ "${{ inputs.browser }}" = "all" ]; then
            echo "BROWSER_FLAG=" >> $GITHUB_OUTPUT
          else
            echo "BROWSER_FLAG=--project=${{ inputs.browser }}" >> $GITHUB_OUTPUT
          fi
          
          # Set grep flag for tags
          if [ "${{ inputs.tags }}" = "all" ]; then
            echo "GREP_FLAG=" >> $GITHUB_OUTPUT
          else
            echo "GREP_FLAG=--grep ${{ inputs.tags }}" >> $GITHUB_OUTPUT
          fi
          
          # Set trace mode
          if [ "${{ inputs.debug }}" = "true" ]; then
            echo "TRACE_FLAG=--trace on" >> $GITHUB_OUTPUT
          else
            echo "TRACE_FLAG=" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ§ª Run tests
        run: |
          npx playwright test \
            ${{ steps.config.outputs.BROWSER_FLAG }} \
            ${{ steps.config.outputs.GREP_FLAG }} \
            ${{ steps.config.outputs.TRACE_FLAG }} \
            --retries ${{ inputs.retries }}
        env:
          CI: true
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
          # Test credentials for Playwright tests and API server
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_ADMIN_EMAIL: ${{ secrets.TEST_ADMIN_EMAIL }}
          TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
          # Frontend credentials (VITE_ prefix for browser access)
          VITE_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          VITE_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          VITE_ADMIN_EMAIL: ${{ secrets.TEST_ADMIN_EMAIL }}
          VITE_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
      
      - name: ðŸ“‹ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Playwright Test Results (${{ inputs.browser }})
          path: test-results/junit.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: ðŸ” Debug - List test artifacts
        if: always()
        run: |
          echo "=== Test Results ==="
          ls -la test-results/ 2>/dev/null || echo "test-results folder not found"
          echo ""
          echo "=== Playwright Report ==="
          ls -la playwright-report/ 2>/dev/null || echo "playwright-report folder not found"
          echo ""
          echo "=== Database file check ==="
          if [ -f ".test-db/test-analytics.db" ]; then
            echo "Database exists: $(ls -la .test-db/test-analytics.db)"
            echo "Database size: $(du -h .test-db/test-analytics.db)"
            # Check for WAL files
            ls -la .test-db/test-analytics.db* 2>/dev/null || echo "No WAL files"
          else
            echo "Database file not found!"
            echo "Contents of .test-db/:"
            ls -la .test-db/ 2>/dev/null || echo ".test-db folder doesn't exist"
          fi

      - name: ðŸ“Š Generate test dashboard
        if: always()
        run: npx tsx tests/scripts/generateDashboard.ts dashboard
      
      - name: ðŸ“¤ Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ inputs.browser }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 14
      
      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ inputs.browser }}-${{ github.run_number }}
          path: test-results/
          retention-days: 14
      
      - name: ðŸ“ˆ Upload dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-dashboard-${{ github.run_number }}
          path: test-results/dashboard.html
          retention-days: 14
      
      - name: ðŸ“‹ Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | ${{ inputs.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | ${{ inputs.tags }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Retries | ${{ inputs.retries }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Debug Mode | ${{ inputs.debug }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Check the artifacts for detailed test reports and dashboard." >> $GITHUB_STEP_SUMMARY
